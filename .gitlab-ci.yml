stages:
  - build
  - test
  - scan

build:
  stage: build
  image: ubuntu:latest
  cache:
    key: conan-cache
    paths:
      - .conan2/data
      - .conan2/p
  script:
    - apt-get update
    - apt-get install -y cmake g++ python3-pip python3-venv
    - python3 -m venv venv
    - . venv/bin/activate

    # Install Conan 2.x
    - pip install "conan>=2.0"

    # Detect profile (ensures compiler/os/build_type/etc. are set)
    - conan profile detect --force

    # Install dependencies and generate toolchain
    - conan install . --output-folder=build --build=missing

    # Configure and build with CMake using Conan-generated toolchain
    - cd build
    - cmake .. -DCMAKE_TOOLCHAIN_FILE=conan_toolchain.cmake -DCMAKE_BUILD_TYPE=Release
    - cmake --build .
  artifacts:
    paths:
      - build/LogFileAnalyzer  # Adjust the path if your binary is elsewhere
    expire_in: 1 week          # Optional: artifact retention duration
  only:
    - main
  
sonarqube:
  stage: test
  image: sonarsource/sonar-scanner-cli:5
  script:
    - sonar-scanner
        -Dsonar.projectKey=LogAnalyzer
        -Dsonar.sources=. 
        -Dsonar.exclusions=build/** 
        -Dsonar.language=cpp
        -Dsonar.host.url=http://sonarqube.khangesh.store/
        -Dsonar.token=${SONAR_TOKEN}
  only:
    - main

dependency-check:
  stage: scan
  image: owasp/dependency-check:latest
  script:
    - echo "ğŸ” Starting OWASP Dependency Check for LogAnalyzer"
    - echo "ğŸ“ Creating report output directory..."
    - mkdir -p owasp-report

    - echo "ğŸš€ Running dependency-check.sh with verbose logging..."
    - dependency-check.sh \
        --project "LogAnalyzer" \
        --scan src \
        --format HTML \
        --out owasp-report \
        --prettyPrint \
        --log owasp-report/scan.log

    - echo "ğŸ“„ Dependency Check completed."
    - echo "ğŸ“‚ Listing files in owasp-report directory:"
    - ls -R owasp-report || echo "âš ï¸ Report directory not found or empty!"

    - echo "ğŸ“‘ Printing log output from scan.log:"
    - cat owasp-report/scan.log || echo "âš ï¸ Log file not found!"
    
    - echo "âœ… Dependency check job finished."
  artifacts:
    paths:
      - owasp-report
    when: always
  only:
    - main




