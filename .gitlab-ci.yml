stages:
  - prepare
  - build

prepare:
  stage: prepare
  image: ubuntu:latest
  cache:
    paths:
      - .conan/data  # cache Conan dependencies
  script:
    - echo "Preparing the environment"
    - apt-get update
    - apt-get install -y cmake g++ python3-pip python3-venv
    - python3 -m venv venv
    - . venv/bin/activate
    - pip install "conan<2.0"
    - conan user  # optional: initialize remote
    - conan install . --build=missing
    - echo "Conan install complete"
  artifacts:
    paths:
      - build/        # optional: if you want to share built files
      - conanbuildinfo.cmake  # or similar
    expire_in: 1h
  only:
    - main

build:
  stage: build
  image: ubuntu:latest
  cache:
    paths:
      - .conan/data  # reuse Conan cache
  script:
    - echo "Building the project"
    - apt-get update
    - apt-get install -y cmake g++ python3-pip python3-venv
    - python3 -m venv venv
    - . venv/bin/activate
    - pip install "conan<2.0"
    - conan user
    - conan install . --build=missing
    - cmake .
    - make
  only:
    - main
